generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mongodb"
  url      = env("DATABASE_URL")
}

model Tenant {
  id   String @id @map("_id") @default(auto()) @db.ObjectId
  name String
  slug String @unique

  users      User[]
  assets     Asset[]
  workOrders WorkOrder[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("tenants")
}

model User {
  id           String @id @map("_id") @default(auto()) @db.ObjectId
  tenantId     String @map("tenant_id") @db.ObjectId
  email        String @unique
  passwordHash String @map("password_hash")
  name         String
  role         String @default("user")

  tenant            Tenant      @relation(fields: [tenantId], references: [id])
  createdWorkOrders WorkOrder[] @relation("CreatedBy")
  assignedWorkOrders WorkOrder[] @relation("Assignee")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("users")
}

enum WorkOrderPriority {
  low
  medium
  high
  urgent
}

enum WorkOrderStatus {
  requested
  assigned
  in_progress
  completed
  cancelled
}

model Asset {
  id       String @id @map("_id") @default(auto()) @db.ObjectId
  tenantId String @map("tenant_id") @db.ObjectId
  code     String
  name     String

  tenant    Tenant     @relation(fields: [tenantId], references: [id])
  workOrders WorkOrder[]


  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("assets")
}

model WorkOrder {
  id            String            @id @map("_id") @default(auto()) @db.ObjectId
  tenantId      String            @map("tenant_id") @db.ObjectId
  siteId        String?           @map("site_id") @db.ObjectId
  title         String
  description   String?
  priority      WorkOrderPriority @default(medium)
  status        WorkOrderStatus   @default(requested)
  assetId       String?           @map("asset_id") @db.ObjectId
  lineName      String?           @map("line_name")
  stationNumber String?           @map("station_number")
  assignedTo    String?           @map("assignee_id") @db.ObjectId
  assignees     String[]          @default([])
  dueDate       DateTime?         @map("due_date")
  category      String?
  attachments   Json?
  checklists    Json?
  partsUsed     Json?             @map("parts_used")
  signatures    Json?
  timeSpentMin  Int?              @map("time_spent_min")
  photos        String[]          @default([])
  failureCode   String?           @map("failure_code")
  pmTaskId      String?           @map("pm_task_id") @db.ObjectId
  requestedBy   String            @map("created_by") @db.ObjectId

  tenant        Tenant   @relation(fields: [tenantId], references: [id])
  assignee      User?    @relation("Assignee", fields: [assignedTo], references: [id])
  createdByUser User     @relation("CreatedBy", fields: [requestedBy], references: [id])
  asset         Asset?   @relation(fields: [assetId], references: [id])


  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("work_orders")
  @@index([tenantId, siteId], map: "work_orders_tenant_site_idx")
  @@index([tenantId, status], map: "work_orders_tenant_status_idx")
  @@index([tenantId, dueDate], map: "work_orders_tenant_duedate_idx")
}
