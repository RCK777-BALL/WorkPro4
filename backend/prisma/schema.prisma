generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mongodb"
  url      = env("DATABASE_URL")
}

model Tenant {
  id   String @id @map("_id") @default(auto()) @db.ObjectId
  name String
  slug String @unique

  users      User[]
  assets     Asset[]
  sites      Site[]
  areas      Area[]
  lines      Line[]
  stations   Station[]
  workOrders WorkOrder[]
  pmPrograms PmProgram[]
  downtimeLogs DowntimeLog[]
  parts        Part[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("tenants")
}

model User {
  id           String @id @map("_id") @default(auto()) @db.ObjectId
  tenantId     String @map("tenant_id") @db.ObjectId
  email        String @unique
  passwordHash String @map("password_hash")
  name         String
  role         String @default("user")

  tenant            Tenant      @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  createdWorkOrders WorkOrder[] @relation("CreatedBy")
  assignedWorkOrders WorkOrder[] @relation("Assignee")
  ownedPmPrograms   PmProgram[] @relation("PmProgramOwner")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("users")
}

enum WorkOrderPriority {
  low
  medium
  high
  urgent
}

enum WorkOrderStatus {
  requested
  assigned
  in_progress
  completed
  cancelled
}

enum AssetStatus {
  operational
  maintenance
  down
  retired
  decommissioned
}

enum PmTriggerType {
  calendar
  meter
}

enum PmTriggerRunStatus {
  success
  skipped
  failed
}

model Asset {
  id       String @id @map("_id") @default(auto()) @db.ObjectId
  tenantId String @map("tenant_id") @db.ObjectId
  siteId   String? @map("site_id") @db.ObjectId
  areaId   String? @map("area_id") @db.ObjectId
  lineId   String? @map("line_id") @db.ObjectId
  stationId String? @map("station_id") @db.ObjectId
  code     String
  name     String
  location String?
  category String?
  purchaseDate DateTime? @map("purchase_date")
  cost     Float?   @map("cost")
  status   AssetStatus @default(operational)
  criticality Int @default(2)
  manufacturer String?
  modelNumber String? @map("model_number")
  serialNumber String? @map("serial_number")
  commissionedAt DateTime? @map("commissioned_at")
  warrantyProvider String? @map("warranty_provider")
  warrantyContact String? @map("warranty_contact")
  warrantyExpiresAt DateTime? @map("warranty_expires_at")
  warrantyNotes String? @map("warranty_notes")

  tenant    Tenant     @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  site      Site?      @relation(fields: [siteId], references: [id])
  area      Area?      @relation(fields: [areaId], references: [id])
  line      Line?      @relation(fields: [lineId], references: [id])
  station   Station?   @relation(fields: [stationId], references: [id])
  workOrders WorkOrder[]
  downtimeLogs DowntimeLog[]
  bomItems AssetBomItem[]


  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("assets")
  @@index([tenantId])
  @@index([tenantId, status])
  @@index([tenantId, siteId])
  @@index([tenantId, lineId])
  @@index([tenantId, stationId])
  @@index([tenantId, areaId])
  @@unique([tenantId, code], map: "assets_tenant_code_key")
}

model Site {
  id       String @id @map("_id") @default(auto()) @db.ObjectId
  tenantId String @map("tenant_id") @db.ObjectId
  code     String? @map("code")
  name     String
  description String?

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  areas  Area[]
  assets Asset[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("sites")
  @@index([tenantId])
  @@unique([tenantId, code], map: "sites_tenant_code_key")
}

model Area {
  id       String @id @map("_id") @default(auto()) @db.ObjectId
  tenantId String @map("tenant_id") @db.ObjectId
  siteId   String @map("site_id") @db.ObjectId
  code     String? @map("code")
  name     String
  description String?

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  site   Site   @relation(fields: [siteId], references: [id], onDelete: Cascade)
  lines  Line[]
  assets Asset[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("areas")
  @@index([tenantId])
  @@index([siteId])
  @@unique([tenantId, siteId, code], map: "areas_site_code_key")
}

model Line {
  id       String @id @map("_id") @default(auto()) @db.ObjectId
  tenantId String @map("tenant_id") @db.ObjectId
  areaId   String @map("area_id") @db.ObjectId
  code     String? @map("code")
  name     String
  description String?

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  area   Area   @relation(fields: [areaId], references: [id], onDelete: Cascade)
  stations Station[]
  assets Asset[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("lines")
  @@index([tenantId])
  @@index([areaId])
  @@unique([tenantId, areaId, code], map: "lines_area_code_key")
}

model Station {
  id       String @id @map("_id") @default(auto()) @db.ObjectId
  tenantId String @map("tenant_id") @db.ObjectId
  lineId   String @map("line_id") @db.ObjectId
  code     String? @map("code")
  name     String
  description String?
  position Int? @map("position")

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  line   Line   @relation(fields: [lineId], references: [id], onDelete: Cascade)
  assets Asset[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("stations")
  @@index([tenantId])
  @@index([lineId])
  @@unique([tenantId, lineId, code], map: "stations_line_code_key")
}

model AssetBomItem {
  id       String @id @map("_id") @default(auto()) @db.ObjectId
  tenantId String @map("tenant_id") @db.ObjectId
  assetId  String @map("asset_id") @db.ObjectId
  position Int    @default(0)
  reference String @map("reference")
  description String
  quantity Float? @map("quantity")
  unit     String? @map("unit")
  notes    String? @map("notes")

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  asset  Asset  @relation(fields: [assetId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("asset_bom_items")
  @@index([assetId])
  @@index([tenantId, assetId], map: "asset_bom_tenant_asset_idx")
}

model WorkOrder {
  id            String            @id @map("_id") @default(auto()) @db.ObjectId
  tenantId      String            @map("tenant_id") @db.ObjectId
  siteId        String?           @map("site_id") @db.ObjectId
  lineId        String?           @map("line_id") @db.ObjectId
  title         String
  description   String?
  priority      WorkOrderPriority @default(medium)
  status        WorkOrderStatus   @default(requested)
  assetId       String?           @map("asset_id") @db.ObjectId
  assigneeId    String?           @map("assigned_to") @db.ObjectId
  category      String?
  dueDate       DateTime?         @map("due_date")
  attachments   String[]          @default([])

  partsUsed     Json?             @map("parts_used")
  signatures    Json?
  timeSpentMin  Int?              @map("time_spent_min")
  failureCode   String?           @map("failure_code")
  pmProgramId   String?           @map("pm_program_id") @db.ObjectId
  pmTriggerId   String?           @map("pm_trigger_id") @db.ObjectId
  pmTaskId      String?           @map("pm_task_id") @db.ObjectId
  createdBy     String            @map("created_by") @db.ObjectId
  startedAt     DateTime?         @map("started_at")
  completedAt   DateTime?         @map("completed_at")
  isPreventive  Boolean           @map("is_preventive") @default(false)

  tenant        Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  assignee      User?    @relation("Assignee", fields: [assigneeId], references: [id])
  createdByUser User     @relation("CreatedBy", fields: [createdBy], references: [id])

  asset         Asset?   @relation(fields: [assetId], references: [id])
  pmProgram     PmProgram? @relation(fields: [pmProgramId], references: [id])
  pmTrigger     PmTrigger? @relation(fields: [pmTriggerId], references: [id])
  pmTask        PmTask?    @relation(fields: [pmTaskId], references: [id])
  triggerRuns   PmTriggerRun[]


  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("work_orders")
  @@index([tenantId, siteId], map: "work_orders_tenant_site_idx")
  @@index([tenantId, status], map: "work_orders_tenant_status_idx")
  @@index([tenantId, dueDate], map: "work_orders_tenant_duedate_idx")
  @@index([tenantId, status, priority], map: "work_orders_tenant_status_priority_idx")
  @@index([tenantId, completedAt], map: "work_orders_tenant_completed_idx")
}

model PmProgram {
  id          String   @id @map("_id") @default(auto()) @db.ObjectId
  tenantId    String   @map("tenant_id") @db.ObjectId
  ownerId     String   @map("owner_id") @db.ObjectId
  name        String
  description String?
  assetId     String?  @map("asset_id") @db.ObjectId
  timezone    String   @default("UTC")
  isActive    Boolean  @map("is_active") @default(true)
  lastGeneratedAt DateTime? @map("last_generated_at")

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  owner  User   @relation("PmProgramOwner", fields: [ownerId], references: [id])
  asset  Asset? @relation(fields: [assetId], references: [id])

  tasks     PmTask[]
  triggers  PmTrigger[]
  workOrders WorkOrder[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("pm_programs")
  @@index([tenantId])
  @@index([tenantId, isActive])
  @@index([ownerId])
}

model PmTask {
  id             String  @id @map("_id") @default(auto()) @db.ObjectId
  programId      String  @map("program_id") @db.ObjectId
  title          String
  instructions   String?
  position       Int     @default(0)
  estimatedMinutes Int?  @map("estimated_minutes")
  requiresSignOff Boolean @map("requires_sign_off") @default(false)

  program   PmProgram @relation(fields: [programId], references: [id], onDelete: Cascade)
  workOrders WorkOrder[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("pm_tasks")
  @@index([programId])
  @@index([programId, position])
}

model PmTrigger {
  id            String        @id @map("_id") @default(auto()) @db.ObjectId
  programId     String        @map("program_id") @db.ObjectId
  type          PmTriggerType
  cronExpression String?      @map("cron_expression")
  intervalDays  Int?          @map("interval_days")
  meterThreshold Float?       @map("meter_threshold")
  settings      Json?         @map("settings")
  startDate     DateTime?     @map("start_date")
  endDate       DateTime?     @map("end_date")
  lastRunAt     DateTime?     @map("last_run_at")
  nextRunAt     DateTime?     @map("next_run_at")
  isActive      Boolean       @map("is_active") @default(true)

  program PmProgram @relation(fields: [programId], references: [id], onDelete: Cascade)
  runs    PmTriggerRun[]
  workOrders WorkOrder[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("pm_triggers")
  @@index([programId])
  @@index([isActive, nextRunAt])
  @@index([programId, isActive, nextRunAt])
}

model PmTriggerRun {
  id          String            @id @map("_id") @default(auto()) @db.ObjectId
  triggerId   String            @map("trigger_id") @db.ObjectId
  status      PmTriggerRunStatus
  runAt       DateTime          @map("run_at") @default(now())
  scheduledFor DateTime?        @map("scheduled_for")
  workOrderId String?           @map("work_order_id") @db.ObjectId
  details     Json?
  error       String?

  trigger   PmTrigger @relation(fields: [triggerId], references: [id], onDelete: Cascade)
  workOrder WorkOrder? @relation(fields: [workOrderId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("pm_trigger_runs")
  @@index([triggerId])
  @@index([status, runAt])
}

model DowntimeLog {
  id        String   @id @map("_id") @default(auto()) @db.ObjectId
  tenantId  String   @map("tenant_id") @db.ObjectId
  assetId   String   @map("asset_id") @db.ObjectId
  siteId    String?  @map("site_id") @db.ObjectId
  lineId    String?  @map("line_id") @db.ObjectId
  startedAt DateTime @map("started_at")
  endedAt   DateTime @map("ended_at")
  minutes   Int      @default(0)

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  asset  Asset  @relation(fields: [assetId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("downtime_logs")
  @@index([tenantId, startedAt], map: "downtime_tenant_started_idx")
  @@index([tenantId, assetId], map: "downtime_tenant_asset_idx")
}

model Part {
  id        String @id @map("_id") @default(auto()) @db.ObjectId
  tenantId  String @map("tenant_id") @db.ObjectId
  siteId    String? @map("site_id") @db.ObjectId
  name      String
  sku       String? @unique
  onHand    Int     @map("on_hand") @default(0)
  minLevel  Int     @map("min_level") @default(0)
  cost      Float?  @map("cost")
  vendor    String?

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("parts")
  @@index([tenantId])
  @@index([minLevel, onHand, tenantId], map: "parts_min_onhand_tenant_idx")
}
