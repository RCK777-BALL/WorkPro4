generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mongodb"
  url      = env("DATABASE_URL")
}

model Tenant {
  id   String @id @map("_id") @default(auto()) @db.ObjectId
  name String
  slug String @unique

  users         User[]
  assets        Asset[]
  workOrders    WorkOrder[]
  parts         Part[]
  warehouses    Warehouse[]
  stockLevels   StockLevel[]
  vendors       Vendor[]
  purchaseOrders PurchaseOrder[]
  downtimeLogs  DowntimeLog[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("tenants")
}

model User {
  id           String @id @map("_id") @default(auto()) @db.ObjectId
  tenantId     String @map("tenant_id") @db.ObjectId
  email        String @unique
  passwordHash String @map("password_hash")
  name         String
  role         String @default("user")

  tenant            Tenant      @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  createdWorkOrders WorkOrder[] @relation("CreatedBy")
  assignedWorkOrders WorkOrder[] @relation("Assignee")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("users")
}

enum WorkOrderPriority {
  low
  medium
  high
  urgent
}

enum WorkOrderStatus {
  requested
  assigned
  in_progress
  completed
  cancelled
}

enum AssetStatus {
  operational
  maintenance
  down
  retired
  decommissioned
}

model Asset {
  id       String @id @map("_id") @default(auto()) @db.ObjectId
  tenantId String @map("tenant_id") @db.ObjectId
  siteId   String? @map("site_id") @db.ObjectId
  lineId   String? @map("line_id") @db.ObjectId
  code     String
  name     String
  location String?
  category String?
  purchaseDate DateTime? @map("purchase_date")
  cost     Float?   @map("cost")
  status   AssetStatus @default(operational)

  tenant    Tenant     @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  workOrders WorkOrder[]
  downtimeLogs DowntimeLog[]


  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("assets")
  @@index([tenantId])
  @@index([tenantId, status])
  @@index([tenantId, siteId])
  @@index([tenantId, lineId])
}

model WorkOrder {
  id            String            @id @map("_id") @default(auto()) @db.ObjectId
  tenantId      String            @map("tenant_id") @db.ObjectId
  siteId        String?           @map("site_id") @db.ObjectId
  lineId        String?           @map("line_id") @db.ObjectId
  title         String
  description   String?
  priority      WorkOrderPriority @default(medium)
  status        WorkOrderStatus   @default(requested)
  assetId       String?           @map("asset_id") @db.ObjectId
  assigneeId    String?           @map("assigned_to") @db.ObjectId
  category      String?
  dueDate       DateTime?         @map("due_date")
  attachments   String[]          @default([])

  partsUsed     Json?             @map("parts_used")
  signatures    Json?
  timeSpentMin  Int?              @map("time_spent_min")
  failureCode   String?           @map("failure_code")
  pmTaskId      String?           @map("pm_task_id") @db.ObjectId
  createdBy     String            @map("created_by") @db.ObjectId
  startedAt     DateTime?         @map("started_at")
  completedAt   DateTime?         @map("completed_at")
  isPreventive  Boolean           @map("is_preventive") @default(false)

  tenant        Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  assignee      User?    @relation("Assignee", fields: [assigneeId], references: [id])
  createdByUser User     @relation("CreatedBy", fields: [createdBy], references: [id])

  asset         Asset?   @relation(fields: [assetId], references: [id])


  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("work_orders")
  @@index([tenantId, siteId], map: "work_orders_tenant_site_idx")
  @@index([tenantId, status], map: "work_orders_tenant_status_idx")
  @@index([tenantId, dueDate], map: "work_orders_tenant_duedate_idx")
  @@index([tenantId, status, priority], map: "work_orders_tenant_status_priority_idx")
  @@index([tenantId, completedAt], map: "work_orders_tenant_completed_idx")
}

model DowntimeLog {
  id        String   @id @map("_id") @default(auto()) @db.ObjectId
  tenantId  String   @map("tenant_id") @db.ObjectId
  assetId   String   @map("asset_id") @db.ObjectId
  siteId    String?  @map("site_id") @db.ObjectId
  lineId    String?  @map("line_id") @db.ObjectId
  startedAt DateTime @map("started_at")
  endedAt   DateTime @map("ended_at")
  minutes   Int      @default(0)

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  asset  Asset  @relation(fields: [assetId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("downtime_logs")
  @@index([tenantId, startedAt], map: "downtime_tenant_started_idx")
  @@index([tenantId, assetId], map: "downtime_tenant_asset_idx")
}

enum PurchaseOrderStatus {
  draft
  issued
  received
  closed
}

model Vendor {
  id        String   @id @map("_id") @default(auto()) @db.ObjectId
  tenantId  String   @map("tenant_id") @db.ObjectId
  name      String
  contact   Json?

  tenant         Tenant          @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  parts          Part[]          @relation("PreferredVendor")
  purchaseOrders PurchaseOrder[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("vendors")
  @@index([tenantId])
  @@index([tenantId, name])
}

model Warehouse {
  id         String  @id @map("_id") @default(auto()) @db.ObjectId
  tenantId   String  @map("tenant_id") @db.ObjectId
  name       String
  code       String?
  location   String?
  isDefault  Boolean @map("is_default") @default(false)

  tenant      Tenant       @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  stockLevels StockLevel[]
  purchaseLines PurchaseOrderLine[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("warehouses")
  @@index([tenantId])
  @@unique([tenantId, code], map: "warehouse_tenant_code_unique")
}

model Part {
  id               String  @id @map("_id") @default(auto()) @db.ObjectId
  tenantId         String  @map("tenant_id") @db.ObjectId
  sku              String
  name             String
  description      String?
  unitOfMeasure    String? @map("unit_of_measure")
  cost             Float?  @map("unit_cost")
  defaultMinLevel  Int     @map("default_min_level") @default(0)
  defaultMaxLevel  Int     @map("default_max_level") @default(0)
  preferredVendorId String? @map("preferred_vendor_id") @db.ObjectId

  tenant          Tenant             @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  preferredVendor Vendor?            @relation("PreferredVendor", fields: [preferredVendorId], references: [id])
  stockLevels     StockLevel[]
  purchaseLines   PurchaseOrderLine[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("parts")
  @@index([tenantId])
  @@unique([tenantId, sku], map: "parts_tenant_sku_unique")
}

model StockLevel {
  id          String     @id @map("_id") @default(auto()) @db.ObjectId
  tenantId    String     @map("tenant_id") @db.ObjectId
  partId      String     @map("part_id") @db.ObjectId
  warehouseId String     @map("warehouse_id") @db.ObjectId
  onHand      Int        @map("on_hand") @default(0)
  onOrder     Int        @map("on_order") @default(0)
  allocated   Int        @default(0)
  minLevel    Int        @map("min_level") @default(0)
  maxLevel    Int        @map("max_level") @default(0)

  tenant    Tenant    @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  part      Part      @relation(fields: [partId], references: [id], onDelete: Cascade)
  warehouse Warehouse @relation(fields: [warehouseId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("stock_levels")
  @@unique([partId, warehouseId], map: "stock_levels_part_wh_unique")
  @@index([tenantId, partId])
}

model PurchaseOrder {
  id         String               @id @map("_id") @default(auto()) @db.ObjectId
  tenantId   String               @map("tenant_id") @db.ObjectId
  vendorId   String               @map("vendor_id") @db.ObjectId
  status     PurchaseOrderStatus  @default(draft)
  number     String?
  notes      String?
  orderedAt  DateTime?            @map("ordered_at")
  receivedAt DateTime?            @map("received_at")

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  vendor Vendor @relation(fields: [vendorId], references: [id], onDelete: Cascade)
  lines  PurchaseOrderLine[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("purchase_orders")
  @@index([tenantId])
  @@index([tenantId, status])
}

model PurchaseOrderLine {
  id              String        @id @map("_id") @default(auto()) @db.ObjectId
  tenantId        String        @map("tenant_id") @db.ObjectId
  purchaseOrderId String        @map("purchase_order_id") @db.ObjectId
  partId          String        @map("part_id") @db.ObjectId
  warehouseId     String?       @map("warehouse_id") @db.ObjectId
  quantity        Int           @default(0)
  receivedQty     Int           @map("received_qty") @default(0)
  unitCost        Float?        @map("unit_cost")

  purchaseOrder PurchaseOrder @relation(fields: [purchaseOrderId], references: [id], onDelete: Cascade)
  part          Part          @relation(fields: [partId], references: [id], onDelete: Cascade)
  warehouse     Warehouse?    @relation(fields: [warehouseId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("purchase_order_lines")
  @@index([tenantId])
  @@index([purchaseOrderId])
  @@index([partId])
}
